---
# Traefik IngressRoute for vLLM OpenAI-compatible API
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: code-llm-api
  namespace: ai-dev
  labels:
    app: vllm
  annotations:
    description: "OpenAI-compatible API for fine-tuned coding LLM"
spec:
  entryPoints:
    - websecure

  routes:
  - match: Host(`code-llm.archer.casa`)
    kind: Rule
    services:
    - name: vllm-server
      port: 8000
    middlewares:
    - name: api-auth
    - name: rate-limit
    - name: headers

  tls:
    certResolver: default
    # Or use specific certificate
    # secretName: code-llm-tls

---
# Middleware: Basic authentication (optional but recommended)
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: api-auth
  namespace: ai-dev
spec:
  basicAuth:
    secret: api-auth-secret
    removeHeader: true

---
# Middleware: Rate limiting to prevent abuse
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: rate-limit
  namespace: ai-dev
spec:
  rateLimit:
    average: 100  # Requests per second
    burst: 200
    period: 1m

---
# Middleware: Security headers
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: headers
  namespace: ai-dev
spec:
  headers:
    customRequestHeaders:
      X-Forwarded-Proto: "https"
    customResponseHeaders:
      X-Frame-Options: "DENY"
      X-Content-Type-Options: "nosniff"
      X-XSS-Protection: "1; mode=block"
      Referrer-Policy: "strict-origin-when-cross-origin"

---
# Secret for basic auth
# Generate password: htpasswd -nb user password | base64
apiVersion: v1
kind: Secret
metadata:
  name: api-auth-secret
  namespace: ai-dev
type: Opaque
data:
  # Default: user/password (CHANGE THIS IN PRODUCTION!)
  # Generated with: echo "user:$(openssl passwd -apr1 password)" | base64
  users: dXNlcjokYXByMSRQN0RnOUNuMyRXeUE3QzdyWEF6S1FYVG5xVkxVdTcwCg==

---
# Alternative: Use stringData for easier configuration
# Uncomment to use:
#
# apiVersion: v1
# kind: Secret
# metadata:
#   name: api-auth-secret
#   namespace: ai-dev
# type: Opaque
# stringData:
#   # Format: username:hashed-password
#   # Generate with: htpasswd -nb username password
#   users: |
#     user:$apr1$P7Dg9Cn3$WyA7C7rXAzKQXTnqVLUu70
